# SQL 소개

SQL은 데이터베이스를 관리하고 조작하기 위해 가장 널리 사용되는 표준 질의어이며, 비절차적 데이터 언어이다.

데이터베이스 시스템 간의 호환성을 위해 ANSI와 국제표준화기구 ISO에서 SQL을 표준 질의어로 채택하고 표준화를 진행했다.

---

## SQL 분류

1. **데이터 정의어 (DDL)**

   - 테이블을 생성, 변경, 삭제하는 기능을 담당한다. 대표적으로 `CREATE`, `ALTER`, `DROP` 명령어가 있다.

2. **데이터 조작어 (DML)**

   - 테이블의 데이터를 삽입, 조회, 수정, 삭제하는 기능을 제공한다. 대표적으로 `SELECT`, `INSERT`, `UPDATE`, `DELETE` 명령어가 있다.

3. **데이터 제어어 (DCL)**

   - 데이터베이스 보안을 위해 사용자별 권한을 부여하거나 회수하며, 주로 데이터베이스 관리자가 사용한다. 대표적으로 `GRANT`, `REVOKE` 명령어가 있다.

---

## SQL을 이용한 데이터 정의

`CREATE TABLE` 문은 테이블의 속성 이름, 데이터 타입, 제약 사항, 기본키/대체키/외래키의 정의, 데이터 무결성을 위한 제약 조건 등을 설정할 수 있다.

### 주요 사항

- **기본키**: 테이블당 하나만 설정할 수 있으며, 기본적으로 `NOT NULL` 특성을 가진다.
- **외래키**: 테이블에 여러 개 존재할 수 있다.
- **세미콜론(;)**: SQL 문장의 끝을 표시한다. 대부분의 SQL 인터페이스에서 관행적으로 사용된다.

  (일반적인 상황에서는 한 문장만 실행하면 세미콜론이 필수는 아니지만, 대부분의 SQL에서  관행적으로 사용)

**대소문자**: SQL 키워드는 대소문자를 구분하지 않는다.

### 오라클 데이터 타입

- `VARCHAR2`: 오라클에서 `VARCHAR`보다 성능이 개선된 데이터 타입으로 더 많이 사용된다.
- `NUMBER`: `NUMERIC`, `DECIMAL` 대신 사용된다.
- `DATE`: 날짜와 시간을 표현하며, `DATETIME`은 지원하지 않는다.

### 속성 관련 주요 사항

- 기본적으로 **NULL 값**이 허용된다. 기본값을 설정하지 않으면 NULL이 기본이다.
- `DEFAULT` 키워드로 기본값을 설정할 수 있다. 이때:
  - 숫자는 그대로 표기한다.
  - 문자열이나 시간 값은 작은따옴표(`'`)로 묶는다.
  - 문자열은 **대소문자를 구분**한다.

### 키의 정의

- **기본키 (PRIMARY KEY)**

  - `PRIMARY KEY` 키워드로 지정한다.
  - 여러 속성으로 구성된 복합 기본키도 가능하다.

- **대체키 (UNIQUE)**

  - `UNIQUE` 키워드로 지정한다.
  - 기본키와 마찬가지로 튜플을 유일하게 식별하며, 테이블 내에서 중복이 허용되지 않는다.
  - 대체키는 한 테이블에 여러 개 지정할 수 있다.

- **외래키 (FOREIGN KEY)**

  - `FOREIGN KEY` 키워드로 지정하며, `REFERENCES` 키워드로 참조하는 속성을 명시한다.
  - 참조 무결성을 위해 참조되는 테이블의 튜플이 함부로 삭제되거나 변경되지 않도록 제한할 수 있다.

#### 외래키와 참조 동작

- **참조하는 테이블** (외래키):

  - `ON DELETE NO ACTION` (기본값): 참조되는 튜플 삭제 금지
  - `ON DELETE CASCADE`: 참조되는 튜플과 함께 삭제
  - `ON DELETE SET NULL`: 외래키 값을 NULL로 설정 후 삭제
  - `ON DELETE SET DEFAULT`: 외래키 값을 기본값으로 설정 후 삭제

- **참조되는 테이블** (기본키):

  - `ON UPDATE NO ACTION` (기본값): 참조되는 튜플 변경 금지
  - `ON UPDATE CASCADE`: 참조하는 튜플도 함께 변경
  - `ON UPDATE SET NULL`: 참조하는 외래키 값을 NULL로 변경
  - `ON UPDATE SET DEFAULT`: 참조하는 외래키 값을 기본값으로 변경

### 데이터 무결성 제약 조건

- **`CHECK`**\*\* 키워드\*\*로 제약 조건을 정의한다.

  - 테이블에서 항상 정확하고 유효한 데이터를 유지하기 위해 사용된다.
  - 예: `CHECK (재고량 >= 0 AND 재고량 <= 1000)`

- **`CONSTRAINT`**\*\* 키워드\*\*로 제약 조건에 고유 이름을 부여할 수 있다.

  - 예: `CONSTRAINT CHK_CPY CHECK (제조업체 = '한빛제과')`

---

## 테이블 변경 및 삭제

### 테이블 변경 (`ALTER TABLE`)

- 새로운 속성 추가: `ALTER TABLE 테이블명 ADD (속성이름 데이터타입);`
- 기존 속성 삭제: `ALTER TABLE 테이블명 DROP COLUMN 속성이름;`
  - 삭제할 속성과 관련된 제약 조건이나 참조하는 속성이 있다면 먼저 삭제해야 한다.
- 새로운 제약 조건 추가: `ALTER TABLE 테이블명 ADD CONSTRAINT 제약조건명 제약조건;`
- 기존 제약 조건 삭제: `ALTER TABLE 테이블명 DROP CONSTRAINT 제약조건명;`

### 테이블 삭제 (`DROP TABLE`)

- 테이블 삭제: `DROP TABLE 테이블명;`
- 오라클에서는 `CASCADE CONSTRAINT` 옵션으로 관련 외래키 제약 조건도 함께 삭제할 수 있다.
  - 그렇지 않다면 삭제하려는 테이블을 참조하는 외래키 제약 조건을 먼저 삭제해야 한다.



# 03 SQL을 이용한 데이터 조작
## 검색
- **SELECT 문**은 동일한 튜플이 중복될 수 있다. 이때 중복을 허용한다는 뜻의 `ALL` 키워드를 명시하여 사용할 수 있다.
- 중복을 제거하려면 `DISTINCT` 키워드를 사용한다.
- **AS**를 이용해 별칭을 만들 수 있다. (AS는 생략 가능하다.)
    - 별칭에 공백이 포함되면 오라클에서는 큰따옴표로 묶고, MSSQL에서는 작은따옴표로 묶어야 한다.
- **WHERE** 키워드를 사용하여 조건 검색이 가능하다.
- **비교 연산자**를 사용하면 숫자뿐만 아니라 문자나 날짜 값도 비교할 수 있다.
    - 숫자 값은 그대로 작성하고, 문자나 날짜 값은 작은따옴표로 묶어야 한다.
- **LIKE** 연산자를 사용하면 부분 검색이 가능하다.
    - `%`는 0개 이상의 문자를, `_`는 1개의 문자를 의미한다.
- **NULL 값**은 `IS NULL`, `IS NOT NULL` 키워드를 사용해야 한다.
    - 예: `나이 = NULL`과 같은 표현은 사용하지 않는다.
- NULL 값은 모든 크기 연산에서 **거짓**으로 간주된다. (즉, `NULL = NULL`은 **false**이다.)
- ORDER BY ASC/DESC를 이용하여 정렬검색이 가능하다.

# SQL을 이용한 데이터 조작 - 고급 검색 기능

## 집계 함수(열 함수)를 이용한 검색
- 특정 속성값을 통계적으로 계산한 결과를 얻으려면 **집계 함수**를 사용할 수 있다.
- 주요 집계 함수:
  - `COUNT`, `MAX`, `MIN`, `SUM`, `AVG`
- **SUM**과 **AVG**는 숫자 타입에만 적용 가능하며, 나머지 함수는 문자, 숫자, 날짜 타입에 모두 적용 가능하다.
- 집계 함수는 **NULL 속성을 제외하고** 계산한다.
- 집계 함수는 **WHERE 절에서는 사용할 수 없고**, `SELECT`와 `HAVING` 절에서만 사용 가능하다.

---

## 그룹별 검색
- **GROUP BY**와 **HAVING(조건 추가)** 형태로 그룹별 검색이 가능하다.
- 그룹별 검색을 사용할 때는, `SELECT` 절에서 그룹을 나누는 기준 속성을 작성하는 것이 좋다.
- **일반 조건 검색**은 `WHERE` 절에 작성하며, **그룹에 대한 조건**은 `HAVING`에 작성한다. 
  - `HAVING` 절에서는 **집계 함수**도 사용할 수 있다.
- 그룹별 검색에서는 집계 함수나 **GROUP BY 절에 있는 속성 외의 속성**을 `SELECT`에서 사용할 수 없다. (사용 시 오류 발생)

---

## 여러 테이블에 대한 조인 검색
- 여러 테이블을 연결할 때는, **연결하려는 속성의 도메인이 서로 같아야 한다.**
- 일반적으로 **테이블의 관계를 나타내는 외래키**를 조인 속성으로 이용한다.
- 테이블에 별칭을 줄 수 있으며, 이때 **AS는 생략 가능하다.**
- **조인 방법**:
  1. `WHERE` 절을 이용해 연결하는 방식이다.
  2. `INNER JOIN ... ON` 키워드를 사용하는 방식이다.
- 위 두 방식은 **동등 조인**에 해당한다.
- 조인 조건을 만족하지 않는 튜플까지 포함하려면 **외부 조인**을 사용해야 한다. 
  - 예: `OUTER JOIN ... ON`
- **LEFT**, **RIGHT**, **FULL OUTER JOIN**을 사용할 때, **LEFT JOIN**에서 양쪽 테이블의 위치를 교환한 뒤 **RIGHT JOIN**으로 바꾸어도 결과는 동일하다.

---

## 부속 질의문을 이용한 검색
- `SELECT`문 안에 또 다른 `SELECT`문을 포함할 수 있다.
- `SELECT`문에 있는 `SELECT`문을 **부속 쿼리(서브 쿼리)**라고 한다.
- 다른 `SELECT`문을 포함하는 `SELECT`문은 **상위 쿼리(주 쿼리)**라고 한다.
- **서브 쿼리는 `ORDER BY` 절을 사용할 수 없으며, 상위 질의문보다 먼저 수행된다.**
- 서브 쿼리는 결과에 따라 두 가지로 분류된다:
  1. **단일 행 서브 쿼리**: 하나의 행을 결과로 반환한다.
  2. **다중 행 서브 쿼리**: 하나 이상의 행을 결과로 반환한다.
- **단일 행 서브 쿼리**는 주 쿼리와 서브 쿼리가 `=`로 연결되며, `=`, `<`, `>`, `<=`, `>=` 등의 일반 연산자와 함께 사용 가능하다.
- **다중 행 서브 쿼리**는 주로 `IN` 연산자를 사용하며,     
 이외에도 `NOT EXISTS`,`EXISTS`, `NOT IN`, `ALL`, `ANY`(비교연산자와 함께 쓰임), `SOME`(비교연산자와 함께 쓰임) 등의 연산자가 존재한다.

---

## 데이터 삽입
- 데이터를 삽입하는 방법은 두 가지가 있다:
  1. `INSERT INTO [tableName] VALUES ([valueList])`이다.
     - 속성값은 순서대로 1대1 대응되며, 개수도 동일해야 한다.
     - 문자나 날짜 속성 값은 작은 따옴표로 묶어야 한다.
  2. `INSERT INTO [tableName] ([columnList]) VALUES ([valueList])`이다.
     - 삽입할 속성을 명시적으로 지정하여 값을 삽입할 수 있다.
     - 이 경우, 지정하지 않은 속성은 **NULL** 값으로 삽입된다.



### 데이터 수정 및 삭제

---

#### **데이터 수정**
- **`UPDATE` 명령어**를 사용하여 데이터 값을 수정한다.

---

#### **데이터 삭제**
- **`DELETE` 명령어**를 사용하여 데이터 삭제 작업을 수행한다.  
- **`WHERE` 절 없이 실행 시** 모든 투플이 삭제되므로 주의해야 한다. 이 경우 테이블 자체는 삭제되지 않으며, 테이블은 빈 상태로 유지된다.

---

### **뷰(View)란?**
뷰(View)는 다른 테이블을 기반으로 만들어진 **가상의 테이블**이다.  
- **특징**  
  - 실제 데이터를 저장하지 않고, **논리적으로만 존재**한다.  
  - 일반 테이블과 유사하게 사용할 수 있어 사용자 입장에서는 큰 차이를 느끼기 어렵다.  
  - **기본 테이블**: 뷰를 생성하기 위해 필요한 물리적인 테이블.  
  - **뷰 기반 구조**: 뷰는 기본 테이블을 기반으로 만들어질 수 있으며, 다른 뷰를 기반으로 생성 가능하다.  
  - **뷰의 역할**: 기본 테이블을 들여다보는 창과 같은 역할을 하며, 동일한 기본 테이블도 뷰에 따라 다른 모습으로 보인다.  
  - **수정 제한**: 검색 외에 삽입, 수정, 삭제와 같은 작업은 제한적으로만 가능하다.

- **생성 구문**  
  - `CREATE VIEW 뷰이름 AS SELECT문`  
  - 뷰는 `ORDER BY` 사용이 불가능하다는 점을 제외하면 `SELECT`문과 동일하게 작성 가능하다.  
  - **WITH CHECK OPTION**: 뷰에 데이터 삽입이나 수정 시, `SELECT`문에서 정의된 조건을 위반하면 변경이 이루어지지 않도록 제한하는 옵션이다.

---

#### **뷰의 활용 예시**  
- 뷰에 대해 **`SELECT` 문**을 실행하면 내부적으로 기본 테이블에서 데이터를 가져온다.  
- **`INSERT`, `UPDATE`, `DELETE` 문**도 뷰를 통해 수행할 수 있지만, 이는 기본 테이블에 영향을 미치므로 제한적으로 사용 가능하다.  
- 다음 조건에 해당하는 경우, 뷰를 통해 데이터 변경이 불가능하다.  
  1. **`DISTINCT` 키워드를 포함**한 경우  
  2. **`GROUP BY` 키워드를 포함**한 경우  
  3. **여러 테이블을 조인**하여 정의된 경우  
  4. **기본키를 포함하지 않은 뷰**의 경우  
  5. **`NOT NULL` 속성이 없는 경우**  
  6. **집계 함수**로 새로 계산된 내용을 포함한 경우  
  - 즉, **어떤 투플이 어떻게 변경되어야 하는지가 모호**한 경우, 뷰를 통해 데이터 변경이 불가하다.  

---

### **뷰(View)의 장점**
1. **질의문 작성의 단순화**  
   - 복잡한 쿼리를 대신하여 미리 만들어둔 뷰를 통해 원하는 데이터를 간단히 검색할 수 있다.  
2. **데이터 보안 강화**  
   - 뷰에 접근 권한을 설정하여 민감한 데이터를 보호할 수 있다.  
3. **데이터 관리의 효율성**  
   - 사용자는 뷰에 포함되지 않는 데이터에 대해 신경 쓸 필요가 없으며, 관리가 용이하다.  

---
## **05 삽입 SQL (Embedded SQL)**

- 지금까지 살펴본 SQL은 DBMS에 직접 입력하여 수행하는 대화식 방식이다.  
- **삽입 SQL**은 프로그래밍 언어로 작성된 응용프로그램 안에 삽입하여 사용하는 SQL문을 의미한다.  
- 응용 프로그램의 논리와 데이터베이스 작업을 통합하여 보다 효율적으로 작업을 수행할 수 있다.

---

### **삽입 SQL의 특징**
1. **명령문 위치**  
   - 일반 명령문이 위치할 수 있는 프로그램 내 모든 곳에 삽입 가능하다.
2. **구문 차별화**  
   - 프로그램의 일반 명령문과 구별하기 위해 SQL 문 앞에 **`EXEC SQL`**을 붙인다.
3. **변수 사용**  
   - 프로그램의 **일반 변수를 삽입 SQL 문에 사용**할 수 있다.  
   - SQL 문에서 일반 변수를 사용할 때는 **콜론(`:`)**을 붙여 테이블 이름이나 속성과 구분해야 한다.
4. **결과 반환 방식**  
   - 여러 행을 반환하는 `SELECT` 문에서는 **커서(Cursor)**가 필요하다.

---

### **커서(Cursor)란?**
- **커서**는 `SELECT` 문 수행 결과로 반환된 여러 행을 **한 번에 처리할 수 없을 때 사용하는 포인터 도구**이다.  
- **커서 사용 이유**  
  - `SELECT` 문의 결과가 여러 행일 경우, 프로그램이 각 행을 차례로 처리할 수 있도록 도와준다.  

---

### **커서 사용 시나리오**
1. **커서가 필요 없는 삽입 SQL**
   - 결과 테이블을 반환하지 않는 SQL 문  
     - 예: `CREATE TABLE`, `INSERT`, `DELETE`, `UPDATE`  
   - 단일 행을 반환하는 `SELECT` 문  
2. **커서가 필요한 삽입 SQL**
   - 결과 테이블의 행이 **여러 개 반환되는 `SELECT` 문**

---

### **커서 사용 방법**
1. **커서 선언**  
   - `EXEC SQL DECLARE 커서이름 CURSOR FOR SELECT 문;`  
   - 프로그램 내에서 커서를 여러 개 선언할 수 있다. 따라서 이름을 붙여 구분한다.
2. **커서 실행**  
   - 연결된 프로그램에서 `SELECT` 문을 시작할 수 있다.
3. **커서 종료**  
   - `EXEC SQL CLOSE 커서이름;` 명령어를 사용하여 커서를 닫는다.

---

#### **삽입 SQL 변수 선언 방법**
- 삽입 SQL 문에서 사용하는 변수는 **특정 선언 범위 내에서 선언**해야 한다.  
- 변수 선언 위치:  
  - `BEGIN DECLARE SECTION`과 `END DECLARE SECTION` 사이에 선언한다.  
  - 이 명령어들은 삽입 SQL의 특별한 명령어이므로 앞에 **`EXEC SQL`**을 붙여 작성한다.  

---
